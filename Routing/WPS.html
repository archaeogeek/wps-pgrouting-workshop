<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>Adding to our WPS | WPS PgRouting Workshop OSGIS 2014</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.3.1">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    <link rel="next" href="../Routing/Map.html" />
    
    
    <link rel="prev" href="../Routing/QGIS.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book" data-level="4.4" data-basepath=".." data-revision="1416661240592">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="Introduction/Overview.html">
            
                
                    <a href="../Introduction/Overview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         Overview
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.1" data-path="Introduction/Summary.html">
            
                
                    <a href="../Introduction/Summary.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                         Package Summary
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2" data-path="Introduction/installation.html">
            
                
                    <a href="../Introduction/installation.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                         Installation
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="GettingStarted/GettingStarted.html">
            
                
                    <a href="../GettingStarted/GettingStarted.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         Getting Started
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="2.1" data-path="GettingStarted/Customising.html">
            
                
                    <a href="../GettingStarted/Customising.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                         Customising Your Server
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.2" data-path="GettingStarted/HelloWorld.html">
            
                
                    <a href="../GettingStarted/HelloWorld.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                         Hello World
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="Geoprocessing/Introduction.html">
            
                
                    <a href="../Geoprocessing/Introduction.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         Basic Geoprocessing
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.1" data-path="Geoprocessing/Testing.html">
            
                
                    <a href="../Geoprocessing/Testing.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                         Testing with QGIS
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="Routing/Overview.html">
            
                
                    <a href="../Routing/Overview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         Routing
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="4.1" data-path="Routing/Functions.html">
            
                
                    <a href="../Routing/Functions.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                         Routing Functions
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4.2" data-path="Routing/PgAdmin3.html">
            
                
                    <a href="../Routing/PgAdmin3.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                         Testing in PgAdmin3
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4.3" data-path="Routing/QGIS.html">
            
                
                    <a href="../Routing/QGIS.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.3.</b>
                        
                         Testing in QGIS
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="4.4" data-path="Routing/WPS.html">
            
                
                    <a href="../Routing/WPS.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.4.</b>
                        
                         Adding to our WPS
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4.5" data-path="Routing/Map.html">
            
                
                    <a href="../Routing/Map.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.5.</b>
                        
                         Using this on a web-based map
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="Appendix/Acknowledgements.html">
            
                
                    <a href="../Appendix/Acknowledgements.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         Wrapping Up
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="Appendix/Proxy.html">
            
                
                    <a href="../Appendix/Proxy.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         University of Nottingham Proxy
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >WPS PgRouting Workshop OSGIS 2014</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_17">
                    
                        <h1 id="routing-as-a-wps-service">Routing as a WPS Service</h1>
<h2 id="simplifying-our-inputs">Simplifying our inputs</h2>
<p>To implement our routing functions as WPS services, we&#39;ll need to decide on which functions we&#39;re going to make available, and decide on the number of parameters that they require.</p>
<p>It&#39;s probably not necessary to give the end-users of a WPS the choice of several different shortest path calculations, and neither is it wise to require them to fill in the name of the various tables and columns needed for the query. As the holders of the routing data we can also decide whether to use direction (aka reverse_cost) in our query. This simplifies the number of inputs, from:</p>
<ul>
<li><strong>function name</strong>;</li>
<li><strong>sql</strong>;</li>
<li><strong>source</strong>;</li>
<li><strong>target</strong>;</li>
<li><strong>directed</strong>;</li>
<li><strong>has_rcost</strong>.</li>
</ul>
<p>to:</p>
<ul>
<li><strong>source</strong>;</li>
<li><strong>target</strong></li>
</ul>
<p>The rest of the parameters will be filled in within our python module, along with the database connection information.</p>
<h2 id="building-the-config">Building the config</h2>
<p>The python coding for this is going to get quite complex (we&#39;ll look through it shortly) but the config is quite straightforward.</p>
<p>On the desktop, click on &quot;File System&quot; and navigate to &quot;usr\lib\cgi-bin\routing&quot;. There are a number of service config files in here, but we&#39;ll concentrate on do.zcfg. Right-click to open this in medit. </p>
<p>This config file has the same three sections that we&#39;ve seen previously:</p>
<ul>
<li><strong>metadata</strong>: describing the service;</li>
<li><strong>DataInputs</strong>: descring the inputs;</li>
<li><strong>DataOutputs</strong>: describing the outputs.</li>
</ul>
<h3 id="datainputs">DataInputs</h3>
<p>Since the service requires exactly two inputs- the starting node (source) and end node (target), these are both described in the config as being of type complexData. Each point requires an easting and a northing to be valid, so minOccurs and maxOccurs are both set to 2. </p>
<h3 id="dataoutputs">DataOutputs</h3>
<p>The key thing to note about the output is the format of the output data:</p>
<pre><code>&lt;Default&gt;
    mimeType = application/json
    asReference = true
    msStyle = STYLE COLOR 0 255 0 OUTLINECOLOR 75 75 75 WIDTH 3.8 OUTLINEWIDTH 0.8 END
    useMapserver = true
    extension = json
&lt;/Default&gt;
</code></pre><p>This is a directive to allow ZOO to output in mapserver format, with a style as defined in the msStyle parameter.</p>
<h2 id="the-python-script">The Python script</h2>
<p>The do.zcfg file references service.py in the routing folder, so using medit, open /usr/lib/cgi-bin/routing/service.py.</p>
<p>The scripting for this part is quite complex, and service.py contains a large number of functions that we won&#39;t be covering in this workshop.</p>
<p>Firstly, switch on line numbers in medit by clicking &quot;View/Show Line Numbers&quot;:
<img src="../images/show_linenumbers.png" alt="Show Line Numbers"></p>
<p>Lines 2 to 6 show the additional modules that are needed for running the routing script- the important new one here is psycopg2, which allows python to connect to a postgreSQL database and execute SQL statements.</p>
<p>Line 18 shows the database connection function, and the connection string for the local pgrouting database can be seen clearly.</p>
<p>Scroll down to the &quot;do&quot; module at line 298.</p>
<p>This functions takes the same parameters as our &quot;hello world&quot; function, and like the buffer function, it references a number of helper functions earlier in the script:</p>
<ul>
<li><strong>findNearestEdge</strong> (line 159) computes the nearest edge to start and finish coordinates, and passes them to...</li>
<li><strong>computeRoute</strong> (line 168), which connects to the database and chooses between a number of different variations on the shortest path functions, depending on additional parameters past. Line 180, for example, shows a SQL query to run the pgr_dijkstra function, in a similar way to the one we ran earlier. You will see that they use the length of the edge as the cost rather than length/maxspeed.</li>
</ul>
<p>The rest of the computeRoute function (lines 187 to 275) are designed to create a temporary table in the database holding the results of the journey calculation, along with elevation and descriptive information about each step in the route, all in such a way that it can be converted into feature collections (remember our buffer function did something similar) for output as json. Finally this is returned to the do function in a format suitable for display on the map.</p>
<p>Finally the do function closes it&#39;s connection to the database and returns 3, which is the shortcut for the SERVICE_SUCCEEDED response that the WPS service needs. Phew!</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../Routing/QGIS.html" class="navigation navigation-prev " aria-label="Previous page: Testing in QGIS"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../Routing/Map.html" class="navigation navigation-next " aria-label="Next page: Using this on a web-based map"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
